"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.APIClientManagerAPI = exports.ApiClientMissingError = void 0;
const index_js_1 = require("../apiClient/index.js");
const globals_js_1 = require("../utils/globals.js");
const getEnv_js_1 = require("../utils/getEnv.js");
const API_NAME = "api-client";
class ApiClientMissingError extends Error {
    constructor(message) {
        super(message);
        this.name = "ApiClientMissingError";
    }
}
exports.ApiClientMissingError = ApiClientMissingError;
class APIClientManagerAPI {
    static _instance;
    constructor() { }
    static getInstance() {
        if (!this._instance) {
            this._instance = new APIClientManagerAPI();
        }
        return this._instance;
    }
    disable() {
        (0, globals_js_1.unregisterGlobal)(API_NAME);
    }
    get baseURL() {
        const config = this.#getConfig();
        return config?.baseURL ?? (0, getEnv_js_1.getEnvVar)("TRIGGER_API_URL") ?? "https://api.trigger.dev";
    }
    get accessToken() {
        const config = this.#getConfig();
        return (config?.secretKey ??
            config?.accessToken ??
            (0, getEnv_js_1.getEnvVar)("TRIGGER_SECRET_KEY") ??
            (0, getEnv_js_1.getEnvVar)("TRIGGER_ACCESS_TOKEN"));
    }
    get branchName() {
        const config = this.#getConfig();
        const value = config?.previewBranch ??
            (0, getEnv_js_1.getEnvVar)("TRIGGER_PREVIEW_BRANCH") ??
            (0, getEnv_js_1.getEnvVar)("VERCEL_GIT_COMMIT_REF") ??
            undefined;
        return value ? value : undefined;
    }
    get client() {
        if (!this.baseURL || !this.accessToken) {
            return undefined;
        }
        const requestOptions = this.#getConfig()?.requestOptions;
        const futureFlags = this.#getConfig()?.future;
        return new index_js_1.ApiClient(this.baseURL, this.accessToken, this.branchName, requestOptions, futureFlags);
    }
    clientOrThrow(config) {
        const baseURL = config?.baseURL ?? this.baseURL;
        const accessToken = config?.accessToken ?? config?.secretKey ?? this.accessToken;
        if (!baseURL || !accessToken) {
            throw new ApiClientMissingError(this.apiClientMissingError());
        }
        const branchName = config?.previewBranch ?? this.branchName;
        const requestOptions = config?.requestOptions ?? this.#getConfig()?.requestOptions;
        const futureFlags = config?.future ?? this.#getConfig()?.future;
        return new index_js_1.ApiClient(baseURL, accessToken, branchName, requestOptions, futureFlags);
    }
    runWithConfig(config, fn) {
        const originalConfig = this.#getConfig();
        const $config = { ...originalConfig, ...config };
        (0, globals_js_1.registerGlobal)(API_NAME, $config, true);
        return fn().finally(() => {
            (0, globals_js_1.registerGlobal)(API_NAME, originalConfig, true);
        });
    }
    setGlobalAPIClientConfiguration(config) {
        return (0, globals_js_1.registerGlobal)(API_NAME, config);
    }
    #getConfig() {
        return (0, globals_js_1.getGlobal)(API_NAME);
    }
    apiClientMissingError() {
        const hasBaseUrl = !!this.baseURL;
        const hasAccessToken = !!this.accessToken;
        if (!hasBaseUrl && !hasAccessToken) {
            return `You need to set the TRIGGER_API_URL and TRIGGER_SECRET_KEY environment variables. See https://trigger.dev/docs/management/overview#authentication`;
        }
        else if (!hasBaseUrl) {
            return `You need to set the TRIGGER_API_URL environment variable. See https://trigger.dev/docs/management/overview#authentication`;
        }
        else if (!hasAccessToken) {
            return `You need to set the TRIGGER_SECRET_KEY environment variable. See https://trigger.dev/docs/management/overview#authentication`;
        }
        return `Unknown error`;
    }
}
exports.APIClientManagerAPI = APIClientManagerAPI;
//# sourceMappingURL=index.js.map